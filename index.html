<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gore Facility Energy Sankey (Highcharts + Render Proxy)</title>

  <!-- 1. Load Highcharts core + Sankey module -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/sankey.js"></script>

  <!-- 2. Load our mapping data (unchanged) -->
  <script src="mapping.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
    }
    #sankey_div {
      width: 100%;
      max-width: 900px;
      height: 550px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <h2>Gore Facility Energy Flow (Electric &amp; Gas Mains)</h2>
  <div id="sankey_div">Loading chart…</div>

  <script>
    // ─── 1. PROXY‐BASED GraphQL Fetch Helper ──────────────────────────────────

    async function fetchMetric(mappingEntry) {
      const { dataSourceName, metricName } = mappingEntry;

      // dynamically compute last 24 hours
      const to   = new Date();
      const from = new Date(to.getTime() - 24 * 60 * 60 * 1000);

      // convert to ISO strings
      const fromISO = from.toISOString();
      const toISO   = to.toISOString();

      const graphqlBody = {
        query: `
          query($dataSourceName: String!, $name: String!, $from: String!, $to: String!,
                $aggregation: MetricDataAggregationMethod!, $window: String!,
                $samplingWindow: String, $last: Int) {
            dataPoint(dataSourceName: $dataSourceName, name: $name) {
              name
              data(from: $from, to: $to,
                   aggregation: $aggregation, window: $window,
                   samplingWindow: $samplingWindow, last: $last) {
                nodes {
                  time
                  data
                }
              }
            }
          }
        `,
        variables: {
          dataSourceName: dataSourceName,
          name:           metricName,
          from:           fromISO,
          to:             toISO,
          aggregation:    "LAST",
          window:         "1 minute",
          samplingWindow: "1 minute",
          last:           1
        }
      };

      const resp = await fetch(
        'https://sankey-proxy.onrender.com/api/graphql',
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(graphqlBody)
        }
      );
      const json = await resp.json();
      const nodes = json?.data?.dataPoint?.data?.nodes || [];
      return nodes.length ? nodes[0].data : 0;
    }

    // ─── 2. Build & Draw Highcharts Sankey (unchanged) ─────────────────────────

    async function drawHighchartsSankey() {
      const results = await Promise.all(
        sankeyMapping.map(async entry => ({
          system: entry.system,
          source: entry.source,
          value:  await fetchMetric(entry)
        }))
      );

      const mainElectric = results.find(r => r.system === "Main Electric")?.value || 0;
      const mainGas      = results.find(r => r.system === "Main Gas")?.value || 0;

      const electricChildren = results
        .filter(r => r.source === "electric" && r.system !== "Main Electric");
      const gasChildren = results
        .filter(r => r.source === "gas" && r.system !== "Main Gas");

      const sumElectricChildren = electricChildren.reduce((sum, e) => sum + e.value, 0);
      const sumGasChildren      = gasChildren.reduce((sum, e) => sum + e.value, 0);

      const nonSubElectric = Math.max(mainElectric - sumElectricChildren, 0);
      const nonSubGas      = Math.max(mainGas - sumGasChildren, 0);

      const sankeyData = [];
      electricChildren.forEach(c => sankeyData.push([ "Main Electric", c.system, c.value ]));
      if (nonSubElectric > 0) sankeyData.push([ "Main Electric", "Non-Submetered Electric", nonSubElectric ]);
      gasChildren.forEach(c => sankeyData.push([ "Main Gas", c.system, c.value ]));
      if (nonSubGas > 0)      sankeyData.push([ "Main Gas", "Non-Submetered Gas", nonSubGas ]);

      Highcharts.chart('sankey_div', {
        chart: { type: 'sankey' },
        title: { text: 'Gore Facility Energy Flow (Last 24 Hours)' },
        series: [{
          keys: ['from','to','weight'],
          nodes: [
            { id: 'Main Electric', color: '#ffa500' },
            { id: 'Main Gas',      color: '#1a8dff' }
          ],
          data: sankeyData,
          name: 'Energy Flow'
        }],
        tooltip: {
          pointFormat: '{point.from} → {point.to}: <b>{point.weight:.1f} kW</b>'
        },
        credits: { enabled: false }
      });
    }

    document.addEventListener('DOMContentLoaded', drawHighchartsSankey);
  </script>
</body>
</html>
